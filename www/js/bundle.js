!function(e){function o(t){if(n[t])return n[t].exports;var i=n[t]={i:t,l:!1,exports:{}};return e[t].call(i.exports,i,i.exports,o),i.l=!0,i.exports}var n={};o.m=e,o.c=n,o.d=function(e,n,t){o.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:t})},o.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return o.d(n,"a",n),n},o.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},o.p="",o(o.s=0)}([function(e,o){!function(){var e=function(e,o,n,t){t=t||$.noop,!$.sessionStorage.isSet("OmegaTokenExpires")||(new Date).getTime()>$.sessionStorage.get("OmegaTokenExpires")||$.sessionStorage.set("OmegaTokenExpires",(new Date).getTime()+3e5);var i=$.ajax({type:"POST",contentType:"application/json",url:window.location.origin+"/ubus",data:JSON.stringify({jsonrpc:"2.0",id:function(){var e=$.sessionStorage.isSet("OmegaRequestCounter")?$.sessionStorage.get("OmegaRequestCounter"):0;return $.sessionStorage.set("OmegaRequestCounter",e+1),e}(),method:"call",params:[$.sessionStorage.isSet("OmegaToken")?$.sessionStorage.get("OmegaToken"):"00000000000000000000000000000000",e,o,n]}),dataType:"json"});return i.done(function(e){t(e)}),i.fail($.noop),i.always($.noop),i};$("#skipIntro").click(function(e){U(N)});var o=function(e){$("#login-message").append($('<div class="alert alert-warning alert-dismissible fade in" role="alert"> \t\t\t<button type="button" class="close" data-dismiss="alert" aria-label="Close"> \t\t\t\t<span aria-hidden="true">&times;</span> \t\t\t\t<span class="sr-only">Close</span> \t\t\t</button> \t\t\t<strong>Error:</strong> '+e+" \t\t</div>"))};$("#login-form").submit(function(n){n.preventDefault(),$("#loginButton").prop("disabled",!0),e("session","login",{username:$("#login-username").val(),password:$("#login-password").val()},function(e){if(console.log(e),e&&e.error)o(e.error.message),$("#loginCard").removeClass("shakeClass"),setTimeout(function(){$("#loginCard").addClass("shakeClass")},100);else if(e&&e.result){0===e.result[0]?($.sessionStorage.set("OmegaToken",e.result[1].ubus_rpc_session),$.sessionStorage.set("OmegaTokenExpires",(new Date).getTime()+1e3*e.result[1].expires),U(N)):($("#loginButton").prop("disabled",!1),o("Login failed."),$("#loginCard").removeClass("shakeClass"),setTimeout(function(){$("#loginCard").addClass("shakeClass")},100))}})}),$("#login-username").keypress(function(e){if(13===e.which)return e.preventDefault(),$("#login-password").focus(),!1});var n={};n.availableWifiNetworks=[],n.configuredWifiNetworks=[];var t="0",i={messageField:"#wifi-message",button:"#wifi-scan-btn",icon:"#wifi-scan-icon",dropdown:"#wifi-select",ssidField:"#wifi-ssid",passwordField:"#wifi-key",encryptionField:"#wifi-encryption",submitButton:"#wifi-config-button"},s="Configure WiFi",l='Configuring<div id="wifi-loading" class="wifiLoad" style="display: block;">';device_getConfiguredNetworks=function(o){console.log("checking for configured networks"),e("onion","wifi-setup",{command:"list",params:{}},function(e){e.result&&void 0!==e.result[0]&&0===e.result[0]?o(null,e.result[1].results):o(!0,"Could not fetch configured network list from the device")})};var r=function(o){w(o.dropdown,"Scanning..."),$(o.button).prop("disabled",!0),$(o.icon).addClass("rotate"),function(o){e("onion","wifi-scan",{device:"ra0"},function(e){e&&e.error?o(!0,"No Wi-Fi networks found"):e&&e.result&&(0===e.result[0]&&0!==e.result[1].results.length?o(null,e.result[1].results):o(!0,"No Wi-Fi networks found"))})}(function(e,t){if($(o.icon).removeClass("rotate"),$(o.button).prop("disabled",!1),e)w(o.dropdown,"No Wi-Fi networks found");else{w(o.dropdown,"Choose Wi-Fi Network:"),n.availableWifiNetworks=t;for(var i=0;i<n.availableWifiNetworks.length;i++)n.availableWifiNetworks[i].ssid&&$(o.dropdown).append($('<option value="'+i+'">'+n.availableWifiNetworks[i].ssid+"</option>"))}})},a=function(o,n,t,i){f(o),h(o,l),function(e,o,n,t){""===e?t(!0,"Please enter an SSID"):"psk2"===o||"psk"===o?n.length<8||n.length>63?t(!0,"Please enter a valid password. (WPA and WPA2 passwords are between 8 and 63 characters)"):t(null,null):"wep"===o&&5!==n.length&&13!==n.length?t(!0,"Please enter a valid password. (WEP passwords are 5 or 13 characters long)"):t(null,null)}(n,t,i,function(l,r){l?(console.error("Error with network input: ",r),m(o,s),g(o,"danger",r)):function(o,n,t,i){e("onion","wifi-setup",{command:"add",base64:!1,params:{ssid:o,password:t,encr:n}},function(e){e.result&&void 0!==e.result[0]&&0===e.result[0]?e.result[1].success?(console.log("Successfully added wireless network"),i(null,null)):(console.log("Unable to add wireless network."),i(!0,"Unable to add wireless network")):(console.log("Sending request to add wireless network failed"),i(!0,"Sending request to add wireless network failed"))})}(n,t,i,function(t,i){if(t)console.error("Error adding wireless network"),g(o,"warning","Something went wrong communicating with the device, please try again");else{console.log("addWirelessNetwork was successful, checking for connectivity");var l=setInterval(function(){!function(o){console.log("checking if online..."),e("file","exec",{command:"wget",params:["--spider","http://repo.onion.io/"]},function(e){e.result&&void 0!==e.result[1]&&void 0!==e.result[1].code&&0===e.result[1].code?o(!0):o(!1)})}(function(e){e&&(clearTimeout(r),clearInterval(l),console.log("Successfully connected!"),U(N))})},3e3),r=setTimeout(function(){console.error("Connecting to network timed out"),clearInterval(l),m(o,s),g(o,"warning","Unable to connect to "+n+". Please try again.")},6e4)}})})},c=function(o,n){!function(o,n){console.log("giving highest priority to network "+o),e("onion","wifi-setup",{command:"priority",base64:!1,params:{ssid:o,move:"top"}},function(e){e.result&&void 0!==e.result[0]&&0===e.result[0]?e.result[1].success?(console.log("Successfully updated network priority"),n(null,null)):(console.log("Unable to change network priority."),n(!0,"Unable to change network priority.")):(console.log("Sending request to change wireless network priority failed"),n(!0,"Sending request to change wireless network priority failed"))})}(o,function(e,o){e&&console.error(o),d(function(e,o){n(e,o)})})},u=function(o,n){!function(o,n){e("onion","wifi-setup",{command:"remove",base64:!1,params:{ssid:o}},function(e){e.result&&void 0!==e.result[0]&&0===e.result[0]?e.result[1].success?(console.log("Successfully removed network"),n(null,null)):(console.log("Unable to remove network."),n(!0,"Unable to remove network.")):(console.log("Sending request to remove wireless network configuration failed"),n(!0,"Sending request to remove wireless network configuration failed"))})}(o,function(e,o){e&&console.error(o),d(function(e,o){n(e,o)})})},d=function(e){var o=setInterval(function(){device_getConfiguredNetworks(function(i,s){i||s&&s.length>0&&(n.configuredWifiNetworks=s,clearTimeout(t),clearInterval(o),e(null,s))})},3e3),t=setTimeout(function(){console.error("Grabbing updated configured network list timed out"),clearInterval(o),e(!0,"Retrieving network list from device timed out. Please refresh the page and try again")},3e4)},g=function(e,o,n){$(e.messageField).append($('<div class="alert alert-'+o+' alert-dismissible fade in" role="alert"> \t\t\t<button type="button" class="close" data-dismiss="alert" aria-label="Close"> \t\t\t\t<span aria-hidden="true">&times;</span> \t\t\t\t<span class="sr-only">Close</span> \t\t\t</button> \t\t\t'+n+" \t\t</div>"))},f=function(e){$(e.messageField+" > .alert").alert("close")},p=function(e){"loading"===e?($("#wifiLoading").show(),$("#wifi-connect").hide(),$("#wifi-list").hide(),$("#networkTable").hide()):($("#wifiLoading").hide(),"addNetwork"===e?($("#wifi-connect").show(),$("#wifi-list").hide(),$("#networkTable").hide()):"addNetworkOption"===e?(p("addNetwork"),$("#wifiCancelButton").show()):"networkList"===e&&($("#wifi-connect").hide(),$("#wifi-list").show(),$("#networkTable").show()))},w=function(e,o){$(e).empty(),$(e).append($('<option value="" disabled selected>'+o+"</option>"))},h=function(e,o){$(e.submitButton).prop("disabled",!0),$(e.submitButton).html(o)},m=function(e,o){$(e.submitButton).html(o),$(e.submitButton).prop("disabled",!1),$("#wifi-loading").css("display","none")},v=function(e,o,n,t){$(e.ssidField).val(o),$(e.passwordField).val(""),$(e.encryptionField).val(t)},k=function(e){e&&Array.isArray(e)&&($("div").remove("#network-list"),$("#networkTable").append(" <div class='list-group-item layout horizontal end' id='network-list'></div> "),$.each(e,function(e,o){var n="",t="<a class='glyphicons glyphicons-ok' href='#' data-toggle='tooltip' title='Enable Network'></a>";o.enabled&&(n="id='connectedNetwork'",t="");var i=`<div class='list-group-item layout horizontal end'><span ${n} class='glyphicons glyphicons-wifi'></span><span>${o.ssid}</span><div id='${o.ssid}'><a class='glyphicons glyphicons-remove' href='#' data-toggle='tooltip' title='Delete Network'></a>${t}</div></div>`;$("#network-list").append(i),$("#network-list > div").length<=1?$(".glyphicons-remove").hide():$(".glyphicons-remove").show()}))};$("#wifi-scan-btn").click(function(){r(i)}),$("#wifi-select").change(function(){var e=function(e){var o=$(e.dropdown).val();return n.availableWifiNetworks[o]}(i);v(i,e.ssid,0,e.encryption)}),$("#wifi-form").submit(function(e){e.preventDefault(),a(i,$("#wifi-ssid").val(),$("#wifi-encryption").val(),$("#wifi-key").val())}),$("#skipWifiButton").click(function(){console.log("skipWifiButton gets called"),console.log("nextStep in skip TestButton is nextStep",N),console.log(x),U(N)}),$("#addWifiButton").click(function(){console.log("addWifiButton: enabling wifi-connect"),p("addNetworkOption")}),$("#wifiCancelButton").click(function(){console.log("wifiCancelButton: enabling wifi-connect"),p("networkList")}),$("#networkTable").on("click",".glyphicons-ok",function(){p("loading");var e=String($(this).closest("div").prop("id"));console.log("clicked on enable for network "+e),c(e,function(e,o){e||(k(o),p("networkList"))})}),$("#networkTable").on("click",".glyphicons-remove",function(){p("loading");var e=String($(this).closest("div").prop("id"));console.log("clicked on delete for index "+e),u(e,function(e,o){e||(k(o),p("networkList"))})}),$("#openCloudButton").click(function(){window.open("https://cloud.onion.io")}),$("#skipCloudReg").click(function(){U(N)}),$("#setupCloudBackButton").click(function(){console.log("preStep",x),console.log("Back Button from the cloud setup gets called"),U(x)});var b,y=function(o){"https://registerdevice.onion.io"===o.origin&&e("uci","get",{config:"onion",section:"cloud"},function(n){2!==n.result.length?e("uci","add",{config:"onion",type:"cloud",name:"cloud"},function(){e("uci","set",{config:"onion",section:"cloud",values:{deviceId:o.data.content.deviceId,secret:o.data.content.deviceSecret}},function(o){console.log("uci set onion.cloud result:",o),0===o.result[0]?e("uci","commit",{config:"onion"},function(o){0===o.result[0]?(console.log("cloud settings set"),e("file","exec",{command:"/etc/init.d/device-client",params:["restart"]},function(){window.removeEventListener("message",y),window.addEventListener("message",C)})):console.log("Unable to commit cloud settings.")}):console.log("Unable to set cloud settings.")})}):(console.log("Cloud settings added"),e("uci","set",{config:"onion",section:"cloud",values:{deviceId:o.data.content.deviceId,secret:o.data.content.deviceSecret}},function(o){console.log("uci set onion.cloud result:",o),0===o.result[0]?e("uci","commit",{config:"onion"},function(o){0===o.result[0]?(console.log("cloud settings set"),e("file","exec",{command:"/etc/init.d/device-client",params:["restart"]},function(){console.log("Waiting for connection..."),window.removeEventListener("message",y),window.addEventListener("message",C)})):console.log("Unable to commit cloud settings.")}):console.log("Unable to set cloud settings.")}))})},C=function(e){"https://registerdevice.onion.io"===e.origin&&($("#myModal").modal("hide"),U(N),window.removeEventListener("message",C),window.addEventListener("message",y))},B=!0,S=!1,I="false",T=function(){if(!S)var o=setInterval(function(){e("file","stat",{path:b},function(e){e&&2===e.result.length&&($("#download-progress").prop("value",e.result[1].size),e.result[1].size===parseInt(t)&&(S=!0,clearInterval(o),console.log("download complete"),$("#downloading").hide(),$("#upgrade-required").show(),function(){var e=0,o=setInterval(function(){e+=1,$("#time").prop("value",e.toString()),e>=2400&&($("#time").hide(),$("#warning").hide(),$("#success").show(),clearInterval(o))},100)}()))})},1e3)},O=function(){$("#consoleInstall").is(":checked")&&"true"===I?($("#upgradeFirmwareButton").html("Upgrade Firmware and Install Console"),$("#firmwareText").html("<p>Update your Omega to the latest and greatest firmware to get all the newest software goodies from Onion.</p>"),$("#consoleText").html("<p>The Onion Console is a web-based virtual desktop for the Omega that allows you to easily change settings and can be used as an IDE.</p>")):$("#consoleInstall").is(":checked")&&"false"===I?($("#upgradeFirmwareButton").html("Install Console"),$("#firmwareText").html("<p>Your Omega is up to date!</p>"),$("#consoleText").html("<p>The Onion Console is a web-based virtual desktop for the Omega that allows you to easily change settings and can be used as an IDE.</p>")):"true"===I?($("#upgradeFirmwareButton").html("Upgrade Firmware"),$("#firmwareText").html("<p>Update your Omega to the latest and greatest firmware to get all the newest software goodies from Onion.</p>")):($("#upgradeFirmwareButton").html("Finish Setup Wizard"),$("#firmwareText").html("<p>Your Omega is up to date!</p>"))};$("#consoleInstall").click(O),$("#upgradeFirmwareButton").click(function(){B=$("#consoleInstall").is(":checked"),e("uci","set",{config:"onion",section:"console",values:{setup:"1"}},function(o){console.log("uci set onion.console.setup result:",o),0===o.result[0]?e("uci","commit",{config:"onion"},function(e){0===e.result[0]?console.log("console setup set"):console.log("Unable to edit console settings.")}):console.log("Unable to edit console settings.")}),U(N)}),$("#skipFirmwareStep").click(function(){console.log("Skip Firmware Step Button is clicked"),I="false",console.log(I),U(N)}),$("#firmwareBackButton").click(function(){console.log("firmware back button gets called"),U(x)});var L=null;$("#completeBackButton").click(function(){console.log("complete back button gets called"),U(x)});var N,x,F=0,W=[{ready:function(){return!1},init:function(){}},{ready:function(){return!0},init:function(){$.sessionStorage.remove("OmegaRequestCounter"),$.sessionStorage.remove("OmegaToken"),$.sessionStorage.remove("OmegaTokenExpires"),$("#login-username").val(""),$("#login-password").val(""),$("#login-message").html("")}},{ready:function(){return!1},init:function(){$('[data-toggle="tooltip"]').tooltip(),p("loading"),e("system","info",{},function(e){e.result&&2===e.result.length?(!function(e){v(e,"",0,"None")}(i),r(i)):U(x)}),device_getConfiguredNetworks(function(e,o){!e&&o&&o.length>0?(n.configuredWifiNetworks=o,k(o),p("networkList")):(console.log("No configured networks found, error value: ",e),p("addNetwork"))}),e("uci","get",{config:"onion",section:"console",option:"setup"},function(e){console.log("uci get onion.console.setup = ",e),2==e.result.length?"1"==e.result[1].value?(console.log("Skip Buttons should be visible"),$("#skipWifiButton").css("display","block"),$("#setupCloudBackButton").css("display","block"),$("#firmwareBackButton").css("display","block")):(console.log("Skip Buttons are hidden"),console.log("About to hide the setupCloudBackButton"),$("#setupCloudBackButton").css("display","none"),console.log("Hiding setupCloudBackButton"),$("#firmwareBackButton").css("display","none")):(console.log("Got a wack response from the ubus request, hid all skip buttons"),console.log("About to hide the setupCloudBackButton"),$("#setupCloudBackButton").css("display","none"),console.log("Hiding setupCloudBackButton"),$("#firmwareBackButton").css("display","none"))})}},{ready:function(){return console.log("Ready Function for the cloud registration step gets called here"),!1},init:function(){console.log("init function for the cloud registration step gets called here "),$("#cloudLoading").css("display","none"),e("uci","get",{config:"onion",section:"cloud"},function(e){console.log("uci get onion.cloud = ",e),2==e.result.length&&("anonymous"!==e.result[1].values.secret?($("#cloudText").html('<div class="alert alert-info"><p>Your device is registered with the Onion Cloud. Check out <a href="http://cloud.onion.io/" target="_blank">cloud.onion.io</a> to get started!</p></div>'),$("#deviceId-list").css("display","block"),$("#deviceId").html(e.result[1].values.deviceId),$("#registerDeviceButton").html("Register device again as a new device (not recommended)")):$("#deviceId-list").css("display","none"))}),$("#iframe").attr("src","https://registerdevice.onion.io"),window.addEventListener("message",y)}},{ready:function(){return!1},init:function(){$("#softwareLoading").show(),$("#software-content").hide(),function(o){console.log("Checking for upgrade"),e("onion","oupgrade",{params:{check:""}},function(e){console.log("oupgrade returned: ",e),e.result&&void 0!==e.result[0]&&0===e.result[0]?(b=e.result[1].image.local,I=e.result[1].upgrade,t=e.result[1].image.size,$("#download-progress").prop("max",e.result[1].image.size),o(null,null)):o(!0,"Invalid response from device")})}(function(e,o){$("#softwareLoading").hide(),$("#software-content").show(),e?console.error(o):(console.log("upgradeRequired",I),console.log("binDownloaded",S),$("#downloading").hide(),$("#download-complete").hide(),O())})}},{ready:function(){return S},init:function(){$("#success").hide(),"true"===I&&B?($("#upgrade-not-required").hide(),$("#install-console-only").hide(),$("#console-installed").hide(),$("#upgrade-required").hide(),$("#downloading").show(),$("#completeBackButton").hide(),$("#download-progress").prop("value",0),e("uci","set",{config:"onion",section:"console",values:{install:"2"}},function(o){console.log("uci set onion.console.setup result:",o),0===o.result[0]?e("uci","commit",{config:"onion"},function(e){0===e.result[0]?console.log("console setup set"):console.log("Unable to edit console settings.")}):console.log("Unable to edit console settings.")}),console.log("Upgrading"),e("onion","oupgrade",{params:{force:""}}),T()):"true"!==I||B?(S=!0,B?(e("uci","set",{config:"onion",section:"console",values:{install:"1"}},function(o){console.log("uci set onion.console.setup result:",o),0===o.result[0]?e("uci","commit",{config:"onion"},function(o){0===o.result[0]?(console.log("console setup set"),e("onion-helper","background",{command:"console-install-tool"},function(o){console.log("THE RESULT OF THE INSTALL TOOL: ",o),L=setInterval(function(){console.log("this",this),console.log("Inside checkInstallFunction"),e("file","exec",{command:"opkg",params:["list-installed"]},function(e){e.error&&-32002===e.error.code&&(clearInterval(L),$("#console-installed").show(),$("#install-console-only").hide())})}.bind(this),1e4)})):console.log("Unable to edit console settings.")}):console.log("Unable to edit console settings.")}),$("#upgrade-required").hide(),$("#upgrade-not-required").hide(),$("#downloading").hide(),$("#install-console-only").show(),$("#console-installed").hide(),$("#completeBackButton").show()):($("#upgrade-required").hide(),$("#install-console-only").hide(),$("#console-installed").hide(),$("#downloading").hide(),$("#upgrade-not-required").show(),$("#completeBackButton").show())):($("#upgrade-not-required").hide(),$("#install-console-only").hide(),$("#console-installed").hide(),$("#upgrade-required").hide(),$("#downloading").show(),$("#completeBackButton").hide(),$("#download-progress").prop("value",0),console.log("Upgrading"),e("onion","oupgrade",{params:{force:""}}),T())}}],U=function(e){if(x!=e)var o=!0;if(F!==e||0==F&&0==e){x=(F=e)-1,N=F+1;for(var n=$("#steps-indicator").children(),t=$("#steps").children(),i=0;i<n.length;i++)i<=e-1?$(n[i]).addClass("completed"):$(n[i]).removeClass("completed");W[e].init(),console.log("The value of bSlideLeft is:",o),0==e?$(t[e]).show():o?(console.log("Should be going forward"),$(t[e-1]).show().removeClass("shiftLeftIn").removeClass("shiftLeftOut").removeClass("shiftRightOut").removeClass("shiftRightIn").addClass("shiftLeftOut"),setTimeout(function(){$(t[e-1]).hide(),$(t[e]).show().removeClass("shiftLeftIn").removeClass("shiftLeftOut").removeClass("shiftRightOut").removeClass("shiftRightIn").addClass("shiftLeftIn").css("height","auto")},1e3)):($(t[e+1]).show().removeClass("shiftLeftIn").removeClass("shiftLeftOut").removeClass("shiftRightOut").removeClass("shiftRightIn").addClass("shiftRightOut"),setTimeout(function(){$(t[e+1]).hide(),$(t[e]).show().removeClass("shiftLeftIn").removeClass("shiftLeftOut").removeClass("shiftRightOut").removeClass("shiftRightIn").addClass("shiftRightIn").css("height","auto")},1e3))}};$(function(){for(var e=0;e<W.length&&W[e].ready();e++);console.log("step: "+e),U(e)})}()}]);